<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <link rel="stylesheet" href="">
  <script src="https://kit.fontawesome.com/b3e88707b5.js" crossorigin="anonymous"></script>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body style="background: #000000">
  <%- include('../partials/userheader.ejs') %>


    <section class="h-100 h-custom" style="background-color:#000000;">
      <form class="mt-4" id="checkout-form" action="">

        <div class="container py-5 h-100">
          <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col">
              <div class="card">
                <div class="card-body p-4">

                  <div class="row">

                    <div class="col-lg-7">
                      <h5 class="mb-3" style=" font-family: 'Poppins', sans-serif; font-weight: 700;"><a href="/cart"
                          class="text-body text-decoration-none"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                            height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;">
                            <path
                              d="M21 11H6.414l5.293-5.293-1.414-1.414L2.586 12l7.707 7.707 1.414-1.414L6.414 13H21z">
                            </path>
                          </svg>
                          Back to Cart</a></h5>
                      <hr>
                      <div class="d-flex justify-content-between align-items-center mb-4">
                      </div>
                      <%if(address==null){%>
                        <h5> Go to profile and add a primary address to take delivery</h5>
                        <div style="display: flex; align-items: center; justify-content: center;">
                          <div class="my-2"><a href="/profile" class="btn btn-primary profile-button">
                              Go To Profile
                            </a></div>
                        </div>

                        <%}else{%>
                          <div class="card mb-3">
                            <label for="pri" class="card-body">
                              <input type="radio" name="address" id="pri" class="float-end" required
                                value="primaryaddress">
                              <div class="d-flex justify-content-between">
                                <div class="d-flex flex-row align-items-center">

                                  <div class="ms-3">
                                    <h5 style="font-family: 'Poppins', sans-serif; font-weight: 600;">Primary Address
                                    </h5>
                                    <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Real Name :
                                      <%=address.primaryAddress.username%>
                                    </p>
                                    <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Mobile :
                                      <%=address.primaryAddress.mobile%>
                                    </p>
                                    <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Email :
                                      <%=address.primaryAddress.email%>
                                    </p>
                                    <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Postcode :
                                      <%=address.primaryAddress.postcode%>
                                    </p>
                                    <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Area :
                                      <%=address.primaryAddress.area%>
                                    </p>
                                    <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Landmark :
                                      <%=address.primaryAddress.landmark%>
                                    </p>
                                    <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">District :
                                      <%=address.primaryAddress.district%>
                                    </p>
                                    <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">State :
                                      <%=address.primaryAddress.state%>
                                    </p>
                                  </div>
                                </div>
                                <div class="d-flex flex-row align-items-center">

                                </div>
                              </div>
                            </label>

                          </div>


                          <%if(address.secondaryAddress.username){%>

                            <div class="card mb-3">
                              <label for="sec" class="card-body">
                                <input type="radio" id="sec" name="address" class="float-end" required
                                  value="secondaryaddress">

                                <div class="d-flex justify-content-between">
                                  <div class="d-flex flex-row align-items-center">

                                    <div class="ms-3">
                                      <h5 style="font-family: 'Poppins', sans-serif; font-weight: 600;">Secondary
                                        Address</h5>
                                      <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Real Name :
                                        <%=address.secondaryAddress.username%>
                                      </p>
                                      <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Mobile :
                                        <%=address.secondaryAddress.mobile%>
                                      </p>
                                      <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Email :
                                        <%=address.secondaryAddress.email%>
                                      </p>
                                      <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Postcode :
                                        <%=address.secondaryAddress.postcode%>
                                      </p>
                                      <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Area :
                                        <%=address.secondaryAddress.area%>
                                      </p>
                                      <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">Landmark :
                                        <%=address.secondaryAddress.landmark%>
                                      </p>
                                      <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">District :
                                        <%=address.secondaryAddress.district%>
                                      </p>
                                      <p class="small mb-0" style="font-family: 'Poppins', sans-serif;">State :
                                        <%=address.secondaryAddress.state%>
                                      </p>
                                    </div>
                                  </div>
                                  <div class="d-flex flex-row align-items-center">
                                  </div>
                                </div>
                                <a href="/editSecondary" class="float-end"><svg xmlns="http://www.w3.org/2000/svg"
                                    width="24" height="24" viewBox="0 0 24 24"
                                    style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;">
                                    <path d="m16 2.012 3 3L16.713 7.3l-3-3zM4 14v3h3l8.299-8.287-3-3zm0 6h16v2H4z">
                                    </path>
                                  </svg></a>
                              </label>
                            </div>

                            <%}else{%>

                              <a href="/addSecondary" class="btn btn-outline-success"><span
                                  style="font-size: 20px;">+</span> Add Address </a>
                              <%}%>

                                <%}%>

                    </div>

                    <div class="col-lg-5">
                      <div class="card  text-white rounded-3" style="background-color:#000025;
                  <%if(address?.secondaryAddress.username){%>
                   top: 14%;">
                        <%}else{%>
                          ">
                          <%}%>

                            <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center mb-5">
                                <h5 class="mb-0">Payment Type</h5>
                                <img src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/avatar-6.webp"
                                  class="img-fluid rounded-3" style="width: 45px;" alt="Avatar">
                              </div>
                              <p class="small mb-2">We accept </p>
                              <a href="#!" type="submit" class="text-white"><svg xmlns="http://www.w3.org/2000/svg"
                                  width="24" height="24" viewBox="0 0 24 24"
                                  style="fill: rgb(255, 255, 255);transform: ;msFilter:;">
                                  <path
                                    d="M11.454 17.021c.048.041.1.082.151.122a6.173 6.173 0 0 1-3.42 1.03A6.17 6.17 0 0 1 2.01 12a6.175 6.175 0 0 1 9.592-5.144c-.05.043-.1.082-.138.126A6.633 6.633 0 0 0 9.166 12c0 1.925.833 3.755 2.288 5.021zm4.361-11.195a6.14 6.14 0 0 0-3.416 1.03c.049.043.099.082.137.126 1.462 1.263 2.299 3.094 2.299 5.018s-.835 3.753-2.288 5.021c-.049.041-.101.082-.151.122a6.162 6.162 0 0 0 3.418 1.03 6.174 6.174 0 1 0 .001-12.347zM12 7.15A6.152 6.152 0 0 0 9.644 12 6.15 6.15 0 0 0 12 16.853 6.157 6.157 0 0 0 14.357 12 6.15 6.15 0 0 0 12 7.15z">
                                  </path>
                                </svg></a>
                              <a href="#!" type="submit" class="text-white"><svg xmlns="http://www.w3.org/2000/svg"
                                  width="24" height="24" viewBox="0 0 24 24"
                                  style="fill: rgb(255, 255, 255);transform: ;msFilter:;">
                                  <path
                                    d="M16.539 9.186a4.155 4.155 0 0 0-1.451-.251c-1.6 0-2.73.806-2.738 1.963-.01.85.803 1.329 1.418 1.613.631.292.842.476.84.737-.004.397-.504.577-.969.577-.639 0-.988-.089-1.525-.312l-.199-.093-.227 1.332c.389.162 1.09.301 1.814.313 1.701 0 2.813-.801 2.826-2.032.014-.679-.426-1.192-1.352-1.616-.563-.275-.912-.459-.912-.738 0-.247.299-.511.924-.511a2.95 2.95 0 0 1 1.213.229l.15.067.227-1.287-.039.009zm4.152-.143h-1.25c-.389 0-.682.107-.852.493l-2.404 5.446h1.701l.34-.893 2.076.002c.049.209.199.891.199.891h1.5l-1.31-5.939zm-10.642-.05h1.621l-1.014 5.942H9.037l1.012-5.944v.002zm-4.115 3.275.168.825 1.584-4.05h1.717l-2.551 5.931H5.139l-1.4-5.022a.339.339 0 0 0-.149-.199 6.948 6.948 0 0 0-1.592-.589l.022-.125h2.609c.354.014.639.125.734.503l.57 2.729v-.003zm12.757.606.646-1.662c-.008.018.133-.343.215-.566l.111.513.375 1.714H18.69v.001h.001z">
                                  </path>
                                </svg></a>
                              <a href="#!" type="submit" class="text-white"><svg xmlns="http://www.w3.org/2000/svg"
                                  width="24" height="24" viewBox="0 0 24 24"
                                  style="fill: rgb(255, 255, 255);transform: ;msFilter:;">
                                  <path
                                    d="M19.554 9.488c.121.563.106 1.246-.04 2.051-.582 2.978-2.477 4.466-5.683 4.466h-.442a.666.666 0 0 0-.444.166.72.72 0 0 0-.239.427l-.041.189-.553 3.479-.021.151a.706.706 0 0 1-.247.426.666.666 0 0 1-.447.166H8.874a.395.395 0 0 1-.331-.15.457.457 0 0 1-.09-.363c.061-.373.148-.938.267-1.689.117-.75.206-1.314.267-1.689s.15-.938.272-1.685c.121-.748.212-1.31.271-1.685.033-.248.179-.371.433-.371h1.316c.893.013 1.682-.057 2.375-.211 1.172-.262 2.134-.744 2.886-1.449.685-.637 1.203-1.462 1.56-2.473.162-.47.277-.917.352-1.338.006-.041.014-.066.025-.074.008-.011.022-.014.035-.011a.378.378 0 0 1 .062.035c.524.398.854.941.98 1.632zm-1.728-2.836c0 .717-.154 1.508-.465 2.374-.537 1.562-1.547 2.618-3.037 3.168-.758.269-1.602.408-2.535.425 0 .006-.301.007-.904.007l-.903-.007c-.672 0-1.067.32-1.187.964-.013.053-.298 1.83-.855 5.329-.008.066-.048.102-.121.102H4.854a.473.473 0 0 1-.369-.165.469.469 0 0 1-.115-.39L6.702 3.664a.784.784 0 0 1 .276-.483.785.785 0 0 1 .519-.19h6.014c.228 0 .555.044.979.131.428.084.801.194 1.123.321.718.274 1.266.688 1.645 1.237.379.552.568 1.207.568 1.972z">
                                  </path>
                                </svg></a>
                              <a href="#!" type="submit" class="text-white"><svg xmlns="http://www.w3.org/2000/svg"
                                  width="24" height="24" viewBox="0 0 24 24"
                                  style="fill: rgb(255, 255, 255);transform: ;msFilter:;">
                                  <path
                                    d="M20 4H4c-1.103 0-2 .897-2 2v12c0 1.103.897 2 2 2h16c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zM4 6h16v2H4V6zm0 12v-6h16.001l.001 6H4z">
                                  </path>
                                  <path d="M6 14h6v2H6z"></path>
                                </svg></a>

                              <div class="card float-end" style="width:50%; background: #000025; border: none;">
                                <div class="card-body" style="padding: 0;">

                                  <div class="form-group" style="margin-top: 13%;"> <label style="color: #ffffff;">Have
                                      coupon?</label>
                                    <div class="input-group"> <input id="couponbox" type="text"
                                        class="form-control coupon" name="" placeholder="Coupon code"> <span
                                        class="input-group-append"> <button class="btn btn-primary btn-apply coupon"
                                          type="button" onclick="applycoupon('<%=grandTotal%>')">Apply</button> </span> </div>
                                  </div>

                                </div>
                              </div>

                              <p class="small mb-2">Choose your payment method </p>
                              <div class="btn-group">
                                <input type="radio" class="btn-check" name="paymentmethod" id="option1" required
                                  value="Cash on delivery" />
                                <label class="btn btn-success" for="option1">COD</label>

                                <input type="radio" class="btn-check" name="paymentmethod" id="option2" required
                                  value="onlinepayment" />
                                <label class="btn btn-primary" for="option2">Online Payment</label>
                              </div>
                              <hr class="my-4">
                              <div class="d-flex justify-content-between">
                                <p class="mb-2">Subtotal</p>
                                <span class="mb-2">₹ <%=total%>.00</span>
                              </div>

                              <div class="d-flex justify-content-between">
                                <p class="mb-2">Shipping</p>
                                <p class="mb-2">₹ 70.00</p>
                              </div>

                              <div class="d-flex justify-content-between mb-4">
                                <p class="mb-2">Total(Incl. taxes)</p>
                                <span class="mb-2" id="total">₹ <%=grandTotal%>.00</span>
                                <input type="text" name="totalprice" id="totalprice" value="<%=grandTotal%>" hidden>
                                <input type="text" name="userid" id="" value="<%=user%>" hidden>
                              </div>

                              <button type="submit" class="btn btn-block btn-lg btn-outline-light"
                                style="background: #ffffff; ">
                                <div class="d-flex justify-content-between">
                                  <span style="color: #000025;">Place Order<svg xmlns="http://www.w3.org/2000/svg"
                                      width="24" height="24" viewBox="0 0 24 24"
                                      style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;">
                                      <path d="m10 15.586-3.293-3.293-1.414 1.414L10 18.414l9.707-9.707-1.414-1.414z">
                                      </path>
                                    </svg></span>
                                </div>
                              </button>
      </form>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
    </section>
    <script src="sweetalert2.all.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
      $("#checkout-form").submit((e) => {
        e.preventDefault()
        $.ajax({
          url: '/placeorder',
          method: 'post',
          data: $('#checkout-form').serialize(),
          success: (response) => {
            if (response.success) {
              swal("Good job!", "Order Placed  Successfully!", "success");
            } else {
              RazorpayPayment(response)
            }
          }
        })

        function RazorpayPayment(order) {
          var options = {
            "key": "rzp_test_At7vVgtlG23Lyo", // Enter the Key ID generated from the Dashboard
            "amount": order.amount_due, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "Tosh",
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response) {


              varifyPayment(response, order)
            },
            "prefill": {
              "name": "NAZIM AMEER P P",
              "email": "nazimameerpp@gmail.com",
              "contact": "9999999999"
            },
            "notes": {
              "address": "Razorpay Corporate Office"
            },
            "theme": {
              "color": "#3399cc"
            }
          };
          var rzp1 = new Razorpay(options);
          rzp1.open();
        }
        function varifyPayment(payment, order) {
          $.ajax({
            url: '/varify-payment',
            data: {
              payment,
              order
            },
            method: 'post',
            success: (response) => {
              if (response.status) {
                swal("Good job!", "Order Placed  Successfully!", "success");
              } else {
                swal({
                  title: "PAYMENT FAILED!",
                  text: "Something Went Wrong, Please Try Again",
                  icon: "warning",
                  dangerMode: true,
                })
                  .then((willDelete) => {
                    if (willDelete) {
                      swal("Ooops! Your payment was failed please try again!", {

                      });
                    }
                  });
              }
            }
          })
        }
      })
      function applycoupon(grandTotal) {
        const coupon = document.getElementById('couponbox').value;
        $.ajax({
          url: '/applycoupon',
          data: {
            coupon: coupon,
            grandTotal: grandTotal,
          },
          method: 'post',
          success: (response) => {
            if (response.success) {
              Swal.fire({
                position: 'top-end',
                icon: 'success',
                title: 'Coupon Applied Successfully!',
                showConfirmButton: false,
                timer: 1500
              })
            document.getElementById('total').innerText = '₹ '+response.newtotal+'.00';
            document.getElementById('totalprice').value = response.newtotal;
              console.log(document.getElementById('totalprice').value)
            } else {
              Swal.fire({
                position: 'top-end',
                icon: 'error',
                title: 'Oops...!',
                text: 'Enter Valid Coupon!',
                showConfirmButton: false,
                timer: 1500
              })
            }
          },
        })
      }
    </script>
    <%- include('../partials/bootstrapF.ejs') %>